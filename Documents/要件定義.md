## 要件定義書: MailValet（最終確定版）

---

### 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| アプリ名 | **MailValet** |
| プラットフォーム | Windows / macOS / Linux |
| 技術基盤 | Electron |
| 外部連携 | GCP Gmail API, Ollama |
| 多言語対応 | 日本語 / 英語（拡張可能） |
| データ保存場所 | `~/.mailvalet/` |

---

### 2. 機能要件

#### 2.1 認証・アカウント管理

| ID | 機能 | 詳細 |
|----|------|------|
| F-AUTH-01 | OAuth2認証 | GCP Gmail APIによるOAuth2フロー（共通GCP設定を使用） |
| F-AUTH-02 | トークン管理 | アカウント別にアクセストークン・リフレッシュトークンの保存・自動更新 |
| F-AUTH-03 | 複数アカウント登録 | 複数のGmailアカウントを登録可能 |
| F-AUTH-04 | アカウント切替 | ヘッダーからアクティブアカウントを切替 |
| F-AUTH-05 | アカウント一覧表示 | 登録済みアカウントの一覧管理 |
| F-AUTH-06 | 接続状態表示 | 現在のアクティブアカウントの接続状態インジケータ |
| F-AUTH-07 | ログアウト | 選択アカウントの認証情報削除・管理から除外 |
| F-AUTH-08 | アカウント追加 | 新規アカウントのOAuth認証・登録 |
| F-AUTH-09 | 前回アカウント復元 | 起動時に前回選択していたアカウントを自動選択 |

#### 2.2 ラベル管理

| ID | 機能 | 詳細 |
|----|------|------|
| F-LABEL-01 | ラベル一覧取得 | Gmail APIからアカウントのラベル一覧を取得 |
| F-LABEL-02 | ツリー構造構築 | 階層ラベルを `/` で分割しツリー表示 |
| F-LABEL-03 | 複数選択 | チェックボックスで複数ラベルを選択可能 |
| F-LABEL-04 | ラベル更新 | ボタンで最新ラベル一覧を再取得 |
| F-LABEL-05 | 選択状態保存 | アカウント別に選択ラベルを保存 |

#### 2.3 メール取得・キャッシュ

| ID | 機能 | 詳細 |
|----|------|------|
| F-FETCH-01 | デフォルト取得 | グローバル設定の日数分のメールを取得 |
| F-FETCH-02 | 日付範囲指定取得 | 開始日〜終了日を指定して取得 |
| F-FETCH-03 | 取得対象 | アカウント別に設定されたラベルを対象 |
| F-FETCH-04 | 進捗表示 | 取得中のプログレス表示 |
| F-FETCH-05 | サンプリング結果保存 | 取得したメール情報をローカルに保存 |
| F-FETCH-06 | サンプリング期間保存 | 取得時の期間情報を保存・表示 |
| F-FETCH-07 | キャッシュ復元 | 起動時・アカウント切替時に前回結果を再展開 |
| F-FETCH-08 | 最新情報取得 | キャッシュを削除し再度取得 |

#### 2.4 メール一覧・グループ化

| ID | 機能 | 詳細 |
|----|------|------|
| F-LIST-01 | From別グループ化 | メールアドレス部分で同一判定しグループ化 |
| F-LIST-02 | From表示 | 同一アドレスの異なるFrom文字列を改行で表示（distinct） |
| F-LIST-03 | 受信件数表示 | 各Fromからの受信件数を表示 |
| F-LIST-04 | 受信頻度表示 | サンプリング期間に基づく受信頻度（件/日）を表示 |
| F-LIST-05 | 代表件名表示 | 最新メールの件名を代表として表示 |
| F-LIST-06 | AI判定範囲表示 | グループ内のAI判定値の範囲（最小-最大）を表示 |
| F-LIST-07 | ソート機能 | 件数順・頻度順・アルファベット順・最新受信日順 |
| F-LIST-08 | 検索・フィルタ | From/ドメインで絞り込み |

#### 2.5 詳細表示

| ID | 機能 | 詳細 |
|----|------|------|
| F-DETAIL-01 | 詳細ウィンドウ表示 | Fromグループの[>]ボタンでモーダレスポップアップを開く |
| F-DETAIL-02 | 複数ウィンドウ対応 | 異なるFromの詳細を複数同時に表示可能 |
| F-DETAIL-03 | メール一覧 | 選択したFromの受信日時・件名・AI判定結果一覧 |
| F-DETAIL-04 | AI判定範囲表示 | 詳細ウィンドウ内のAI判定値の範囲（最小-最大）を表示 |
| F-DETAIL-05 | 本文表示 | メール行クリックで本文をテキスト化して表示 |
| F-DETAIL-06 | 生データ表示 | ボタンでヘッダを含むメール全体を生で表示 |
| F-DETAIL-07 | 重要/スター表示 | 各メールの重要マーク・スター状態をアイコン表示 |
| F-DETAIL-08 | AI判定結果表示 | グループ全体・個別メールのマーケティング度・迷惑度表示 |

#### 2.6 削除機能

| ID | 機能 | 詳細 |
|----|------|------|
| F-DEL-01 | 削除対象選択 | Fromグループ単位でチェックボックス選択 |
| F-DEL-02 | 一括削除 | 選択したFromからの全期間メールをゴミ箱へ移動 |
| F-DEL-03 | 除外条件 | 重要マーク付き・スター付きは削除対象外 |
| F-DEL-04 | 確認ダイアログ | 一括削除実行前に警告表示、Yes/Noで確認 |
| F-DEL-05 | 削除結果表示 | 削除件数・除外件数のサマリ表示 |

#### 2.7 Ollama AI判定

| ID | 機能 | 詳細 |
|----|------|------|
| F-AI-01 | 自動判定ボタン | Fromグループ画面に表示（Ollama設定済み時のみ有効） |
| F-AI-02 | 判定対象 | 件名とメール本文（HTML/Plain両方）を対象に判断 |
| F-AI-03 | マーケティング度 | 0-10段階で判定 |
| F-AI-04 | 迷惑メール度 | 0-10段階で判定 |
| F-AI-05 | 範囲フィルタ | 判定結果の度合い範囲で絞り込み表示 |
| F-AI-06 | 判定進捗 | 処理中のプログレス表示 |
| F-AI-07 | 判定結果保存 | AI判定結果をキャッシュと共に保存・復元 |
| F-AI-08 | コンテンツベースキャッシュ | 件名+本文のハッシュをキーにキャッシュ（アカウント/From非依存） |
| F-AI-09 | AI判定キャッシュクリア | AI判定キャッシュのみを削除する機能 |

#### 2.8 多言語対応

| ID | 機能 | 詳細 |
|----|------|------|
| F-I18N-01 | 言語自動検出 | 初回起動時にOS言語設定を検出 |
| F-I18N-02 | 言語切替 | 設定画面から言語選択（自動/日本語/英語） |
| F-I18N-03 | 対応言語 | 日本語・英語（初期対応、拡張可能な設計） |

#### 2.9 テーマ

| ID | 機能 | 詳細 |
|----|------|------|
| F-THEME-01 | テーマ自動検出 | OS設定からダーク/ライトモードを検出 |
| F-THEME-02 | テーマ切替 | 設定画面からテーマ選択（自動/ライト/ダーク） |

#### 2.10 GCP JSONインポート

| ID | 機能 | 詳細 |
|----|------|------|
| F-GCP-01 | JSONファイル選択 | ファイルダイアログでcredentials.jsonを選択 |
| F-GCP-02 | 自動パース | JSON構造を解析し、client_id / client_secret / project_id を抽出 |
| F-GCP-03 | 設定値反映 | 抽出した値を各入力欄に自動セット |
| F-GCP-04 | 形式検証 | 不正なJSON / 必須フィールド欠落時にエラー表示 |
| F-GCP-05 | 手動入力併用 | JSONインポート後も各項目の手動編集可能 |

---

### 3. 設定画面項目

#### 3.1 一般設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| 言語 | select | auto | auto（OS検出）/ ja / en |
| テーマ | select | auto | auto（OS検出）/ light / dark |

#### 3.2 メール取得設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| サンプリング日数 | number | 30 | デフォルト取得日数 |
| 最大取得件数 | number | 1000 | 1回の取得上限 |
| 既読/未読フィルタ | select | all | all / unread / read |

#### 3.3 削除設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| 重要メール除外 | boolean | true | 重要マーク付き除外 |
| スター付き除外 | boolean | true | スター付き除外 |

※削除方式はゴミ箱固定、確認ダイアログは一括削除時に固定表示

#### 3.4 Ollama設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| Ollamaホスト | string | http://localhost:11434 | OllamaサーバーURL |
| モデル | select | - | 利用可能モデル一覧から選択 |
| 接続テスト | button | - | 接続確認ボタン |
| タイムアウト | number | 180 | API応答タイムアウト秒数（0で無制限） |
| 同時処理数 | number | 1 | 並列判定数 |

#### 3.5 GCP API設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| GCP認証JSONインポート | file-select | - | credentials.jsonを選択して自動設定 |
| クライアントID | string | - | GCP OAuth2クライアントID（自動/手動） |
| クライアントシークレット | string | - | GCP OAuth2シークレット（自動/手動） |
| プロジェクトID | string | - | GCPプロジェクトID（自動/手動） |
| 設定状態 | display | - | GCP設定の完了状態表示 |

#### 3.6 Gmailアカウント管理

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| 登録アカウント一覧 | list | - | 登録済みGmailアカウント一覧表示 |
| アカウント追加 | button | - | GCP設定を使用して新規OAuth認証 |
| ログアウト | button | - | 選択アカウントの認証情報削除・管理から除外 |

#### 3.6.1 アカウント別設定

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| 取得対象ラベル | tree-multiselect | INBOX | ラベルをツリー表示し複数選択可能 |

#### 3.7 データ管理（グローバル）

| 項目 | 型 | デフォルト | 説明 |
|------|-----|----------|------|
| AI判定キャッシュクリア | button | - | AI判定結果キャッシュのみを削除 |
| 全キャッシュクリア | button | - | 全アカウントのサンプリング結果・AI判定結果を削除 |
| 設定エクスポート | button | - | JSON形式で設定出力（認証情報除く） |
| 設定インポート | button | - | JSON形式で設定読込 |
| 全データリセット | button | - | 全設定・キャッシュ・認証情報の初期化 |

---

### 4. 画面構成

#### 4.1 メイン画面

```
+-------------------------------------------------------------------------------------+
|  MailValet                                                                 [設定]   |
+-------------------------------------------------------------------------------------+
|  [user1@gmail.com ▼]  ● 接続中                                                      |
|  +----------------------+                                                           |
|  | user1@gmail.com  ✓  |                                                           |
|  | user2@gmail.com     |                                                           |
|  | + アカウント追加     |                                                           |
|  +----------------------+                                                           |
+-------------------------------------------------------------------------------------+
|  サンプリング期間: 2024/01/01 - 2024/01/31                                           |
|  取得条件: [日数: 30 ▼] or [開始日]〜[終了日]  [取得] [最新の情報を取得]                |
+-------------------------------------------------------------------------------------+
|  AI判定フィルタ: Marketing [0-10] Spam [0-10]  [適用]                                 |
+-------------------------------------------------------------------------------------+
|  Fromグループ一覧                                                                    |
+-------------------------------------------------------------------------------------+
|  [ ] | From                           | 件数 | 頻度     | 代表件名      | M     | S     |   |
|------|-------------------------------|------|---------|--------------|-------|-------|---|
|  [x] | Marketing Team <news@svc.com> |   45 | 1.5件/日 | Weekly News  | 7-9   | 2-4   |[>]|
|      | Newsletter <news@svc.com>     |      |         |              |       |       |   |
|      | news@svc.com                  |      |         |              |       |       |   |
|------|-------------------------------|------|---------|--------------|-------|-------|---|
|  [ ] | alert@bank.com                |   12 | 0.4件/日 | お取引通知    | 0-2   | 0-1   |[>]|
|------|-------------------------------|------|---------|--------------|-------|-------|---|
|  [ ] | Shop Info <promo@shop.com>    |   89 | 3.0件/日 | 本日限定...   | 8-10  | 1-3   |[>]|
|      | promo@shop.com                |      |         |              |       |       |   |
+-------------------------------------------------------------------------------------+
|  [自動判定] [一括削除]                                                                |
+-------------------------------------------------------------------------------------+
|  ステータス: キャッシュから復元 - 146件 / 3グループ                                     |
+-------------------------------------------------------------------------------------+
```

#### 4.2 詳細ポップアップウィンドウ（モーダレス・複数表示可）

```
+----------------------------------------------------+
|  news@svc.com (45件)                   [_][□][X]   |
+----------------------------------------------------+
|  Marketing: 7-9  |  Spam: 2-4                      |
+----------------------------------------------------+
|  日時              | 件名                   | M | S |
|--------------------|------------------------|---|---|
|  2024/01/31 09:15  | Weekly Newsletter      | 8 | 2 |
|  2024/01/24 09:12  | Weekly Newsletter      | 8 | 2 |
|  2024/01/17 10:03  | Special Offer!         | 9 | 4 |
|  2024/01/15 08:45  | Campaign Update        | 7 | 3 |
|  ...               | ...                    |   |   |
+----------------------------------------------------+

  ↓ メール行クリックで本文表示エリア展開

+----------------------------------------------------+
|  本文: Weekly Newsletter (2024/01/31 09:15)        |
+----------------------------------------------------+
|  重要: [ ]  スター: [★]                            |
|  Marketing: 8/10  |  Spam: 2/10                    |
|                                      [生データ表示] |
|----------------------------------------------------|
|                                                    |
|  今週のニュースレターをお届けします。                |
|                                                    |
|  - トピック1: ...                                  |
|  - トピック2: ...                                  |
|                                                    |
+----------------------------------------------------+
```

#### 4.3 生データ表示（本文エリア切替）

```
+----------------------------------------------------+
|  生データ: Weekly Newsletter (2024/01/31 09:15)    |
+----------------------------------------------------+
|  重要: [ ]  スター: [★]                            |
|  Marketing: 8/10  |  Spam: 2/10                    |
|                                      [本文表示]     |
|----------------------------------------------------|
|  MIME-Version: 1.0                                 |
|  Date: Wed, 31 Jan 2024 09:15:00 +0900             |
|  From: Marketing Team <news@svc.com>               |
|  To: user1@gmail.com                               |
|  Subject: Weekly Newsletter                        |
|  Content-Type: multipart/alternative;              |
|      boundary="000000000000abcdef"                 |
|                                                    |
|  --000000000000abcdef                              |
|  Content-Type: text/plain; charset="UTF-8"         |
|                                                    |
|  今週のニュースレターをお届けします。                |
|  ...                                               |
+----------------------------------------------------+
```

#### 4.4 設定画面

```
+----------------------------------------------------------+
|  設定                                          [閉じる]   |
+----------------------------------------------------------+
|  [一般] [メール取得] [削除] [Ollama] [GCP API] [アカウント] [データ]|
+----------------------------------------------------------+
|                                                          |
|  === 一般設定 ===                                         |
|                                                          |
|  言語:     [自動検出 ▼]                                   |
|  テーマ:   [自動検出 ▼]                                   |
|                                                          |
+----------------------------------------------------------+
|                                        [キャンセル] [保存] |
+----------------------------------------------------------+
```

#### 4.5 アカウント管理

```
+----------------------------------------------------------+
|  === Gmailアカウント管理 ===                               |
|                                                          |
|  登録済みアカウント:                                       |
|  +------------------------------------------------------+|
|  | メールアドレス              | 状態   |               ||
|  |----------------------------|--------|---------------||
|  | user1@gmail.com            | 接続中 | [ログアウト]   ||
|  | user2@gmail.com            | 未接続 | [ログアウト]   ||
|  +------------------------------------------------------+|
|                                                          |
|  [+ アカウントを追加]                                      |
|                                                          |
|  ※ GCP API設定が完了している必要があります                  |
|                                                          |
+----------------------------------------------------------+
```

#### 4.6 アカウント別ラベル設定

```
+------------------------------------------+
|  取得対象ラベル:            [ラベルを更新] |
+------------------------------------------+
|  [ ] すべて選択                           |
|  ─────────────────────                   |
|  [✓] INBOX                               |
|  [ ] SENT                                |
|  [ ] SPAM                                |
|  [ ] TRASH                               |
|  [✓] Work                        [−]     |
|      [✓] Projects                [−]     |
|          [✓] Active                      |
|          [ ] Archive                     |
|      [ ] Clients                         |
|  [ ] Personal                    [+]     |
|                                          |
+------------------------------------------+
|  選択中: INBOX, Work/Projects/Active     |
+------------------------------------------+
```

#### 4.7 データ管理

```
+----------------------------------------------------------+
|  === データ管理 ===                                        |
|                                                          |
|  キャッシュ:                                               |
|  +------------------------------------------------------+|
|  | [AI判定キャッシュクリア]  AI判定結果のみを削除          ||
|  | [全キャッシュクリア]      サンプリング結果含め全削除    ||
|  +------------------------------------------------------+|
|                                                          |
|  設定:                                                    |
|  +------------------------------------------------------+|
|  | [設定エクスポート]  JSON形式で出力（認証情報除く）      ||
|  | [設定インポート]    JSON形式で読込                    ||
|  +------------------------------------------------------+|
|                                                          |
|  リセット:                                                |
|  +------------------------------------------------------+|
|  | [全データリセット]  全設定・キャッシュ・認証情報を初期化||
|  +------------------------------------------------------+|
|                                                          |
+----------------------------------------------------------+
```

---

### 5. データ保存構造

保存場所: `~/.mailvalet/`

```
~/.mailvalet/
  ├── settings/
  │     general.json          # 一般設定（言語、テーマ）
  │     fetch.json            # メール取得設定
  │     delete.json           # 削除設定
  │     ollama.json           # Ollama設定
  │     gcp.json              # GCP API設定（暗号化）
  │
  ├── accounts/
  │     ├── {account_id_1}/
  │     │     profile.json    # メールアドレス、表示名
  │     │     tokens.json     # OAuth トークン（暗号化）
  │     │     labels.json     # 選択ラベル設定
  │     │     └── cache/
  │     │           sampling.json      # サンプリング結果
  │     │           sampling_meta.json # サンプリング期間情報
  │     │
  │     └── {account_id_2}/
  │           ...
  │
  ├── cache/
  │     ai_judgments.json     # AI判定キャッシュ（件名+本文ハッシュをキー、グローバル）
  │
  ├── state/
  │     app.json              # 前回選択アカウント、ウィンドウサイズ等
  │
  └── logs/
        app.log               # アプリケーションログ
```

#### 暗号化対象

| ファイル | 対象項目 |
|----------|----------|
| gcp.json | client_secret |
| tokens.json | access_token, refresh_token |

#### state/app.json 内容

| 項目 | 説明 |
|------|------|
| lastAccountId | 前回選択していたアカウントID |
| windowBounds | ウィンドウサイズ・位置 |

#### AI判定キャッシュ構造（cache/ai_judgments.json）

| 項目 | 説明 |
|------|------|
| キー | 件名+本文のハッシュ値 |
| 値 | マーケティング度、迷惑度、判定日時 |
| 特徴 | アカウント/From非依存、同一コンテンツは再判定不要 |

---

### 6. プラットフォーム別パス

| OS | パス |
|----|------|
| Windows | `C:\Users\{username}\.mailvalet\` |
| macOS | `/Users/{username}/.mailvalet/` |
| Linux | `/home/{username}/.mailvalet/` |

---

### 7. 非機能要件

| カテゴリ | 要件 |
|----------|------|
| セキュリティ | OAuth2トークン・クライアントシークレットの暗号化保存 |
| 拡張性 | 多言語リソースの追加が容易な構造 |
| 可用性 | オフライン時のエラーハンドリング、Ollama未起動時の適切な表示 |
| データ保存 | `~/.mailvalet/` 配下に統一保存 |
| マルチアカウント | アカウント間のデータ分離、切替時の状態保持 |
| ポータビリティ | `~/.mailvalet/` をコピーすることで設定移行可能（要再認証） |
| 状態復元 | 起動時に前回状態（アカウント、ウィンドウサイズ）を復元 |

---

### 8. 固定仕様

| 項目 | 固定値 |
|------|--------|
| 削除方式 | ゴミ箱へ移動 |
| 削除確認 | 一括削除時に1回表示 |
| ウィンドウサイズ | 自動記憶・復元 |
| 起動時データ取得 | しない（キャッシュから復元） |
| テーマ検出 | OS設定から自動検出（切替可能） |
| 言語検出 | OS設定から自動検出（切替可能） |
