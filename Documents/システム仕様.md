# システム仕様書: Mail Valet

## 1. システム概要

Mail Valetは、GmailおよびIMAPメールアカウントを一括管理し、不要メールの整理を効率化するデスクトップアプリケーションである。
Ollama AIによるメール自動判定機能を備え、マーケティングメールや迷惑メールの特定・一括削除を支援する。

Gmail REST API（OAuth2）とIMAP（imapflowライブラリ）の2つのプロバイダに対応し、IPCハンドラでプロバイダを振り分けるアーキテクチャを採用している。

| 項目 | 内容 |
| ------ | ------ |
| アプリ名 | Mail Valet |
| プラットフォーム | Windows / macOS / Linux |
| 技術基盤 | Electron 38 |
| フロントエンド | React 19 + MUI v7 |
| 言語 | TypeScript 5 |
| 状態管理 | Zustand 5 |
| 多言語 | i18next（日本語/英語） |
| ビルド | Vite 7 (Renderer) / tsc (Main) |
| IMAP | imapflow |
| 外部連携 | GCP Gmail API, Ollama |
| データ保存場所 | `~/.mailvalet/` |

### 対応OS

- Windows 10/11
- macOS 10.15+
- Linux (Debian系/RHEL系)

---

## 2. アーキテクチャ

### 2.1 プロセス構成

```text
+-------------------+     IPC      +-------------------+
|   Main Process    | <==========> |  Renderer Process  |
|   (Electron)      |              |  (React + MUI)     |
+-------------------+              +-------------------+
| - IPC Handlers    |              | - Zustand Stores  |
| - File Manager    |              | - UI Components   |
| - Encryption      |              | - i18n            |
| - Settings Mgr    |              +-------------------+
| - Account Mgr     |
| - Gmail Service   |              +-------------------+
| - IMAP Service    |
| - Ollama Service  |    IPC       |  Detail Windows   |
| - State Manager   | <==========> |  (Renderer)       |
+-------------------+              +-------------------+
```

### 2.2 レイヤー構成

| レイヤー | ディレクトリ | 役割 |
| ------ | ------ | ------ |
| Shared | `src/shared/` | 型定義、定数、IPCインターフェース |
| Main | `src/main/` | Electronメインプロセス、サービス、IPCハンドラ |
| Preload | `src/preload/` | IPC APIブリッジ（contextBridge） |
| Renderer | `src/renderer/` | React UI、状態管理、多言語対応 |

### 2.3 メールプロバイダ振り分け

```text
IPCハンドラ
  +-- provider === 'gmail' → GmailService (Gmail REST API + OAuth2)
  +-- provider === 'imap'  → ImapService  (imapflow + クレデンシャル認証)
```

IPCハンドラがアカウントの`provider`フィールドを参照し、Gmail ServiceまたはIMAP Serviceに処理を振り分ける。
メール取得・本文取得・削除などの共通操作は同一のIPCチャネルを使用し、ハンドラ内部でプロバイダ別の実装に分岐する。

---

## 3. 認証・アカウント管理

### 3.1 OAuth2認証フロー（Gmail）

```text
1. ユーザーが「アカウント追加」をクリック
2. Main Process がランダムポートでローカルHTTPサーバーを起動
3. BrowserWindow で Google OAuth2 同意画面を表示
4. ユーザーが認証を許可
5. リダイレクトURLにより認可コードをローカルサーバーが受信
6. 認可コードをアクセストークン・リフレッシュトークンに交換
7. トークンをAES-256-GCMで暗号化して保存
8. ユーザー情報（email, displayName）を取得してプロフィール作成
```

共通のGCP設定（clientId, clientSecret）を使用してOAuth2フローを実行する。

### 3.1.1 IMAP認証フロー

```text
1. ユーザーが「アカウント追加」→「IMAP」を選択
2. IMAP接続設定ダイアログが表示される
3. ホスト、ポート、セキュリティ方式、ユーザー名、パスワードを入力
4. 「接続テスト」ボタンで接続確認（imapflowでIMAPサーバーに接続→ログアウト）
5. 「追加」ボタンでアカウント作成
6. パスワードをAES-256-GCMで暗号化してimap.jsonに保存
7. ユーザー名をメールアドレスとしてプロフィールを作成（provider: 'imap'）
```

IMAP接続はGCP設定不要。操作ごとにimapflowで接続・切断を行い、永続接続プールは使用しない。

Gmail・IMAP共通の接続ポリシー: 外部サーバーへの接続が発生する操作は以下の4種類:

- **接続確認**: アカウント追加時、起動時の接続状態チェック
- **サンプリング（メール取得）**: ヘッダ+本文（plain/html）+生ソースを一括取得し、すべてキャッシュに保存
- **削除操作**: From/Subject/メッセージID指定でゴミ箱へ移動
- **本文オンデマンド取得**: キャッシュにない本文・生ソースをAPIから直接取得（ゴミ箱メール閲覧時等）

AI判定・詳細表示での本文/生ソース参照はサンプリング時のキャッシュ（sampling_{mode}.json内のbodyParts/rawBodies）から優先的に取得する。キャッシュにない場合はAPIからオンデマンドで取得する。

セキュリティ方式:

| 方式 | ポート | 説明 |
| ------ | ------ | ------ |
| SSL/TLS | 993 | 接続時からTLS暗号化（デフォルト） |
| STARTTLS | 143 | 平文接続後にSTARTTLSでTLS昇格 |
| なし | 143 | 暗号化なし |

### 3.2 トークン管理（Gmail）

- アカウント別にアクセストークン・リフレッシュトークンを暗号化保存
- API呼び出し前に`expiresAt`をチェック（60秒のバッファあり）
- 期限切れの場合、リフレッシュトークンで新しいアクセストークンを自動取得
- 更新後のトークンは即座に暗号化保存
- 401応答時にもリトライでリフレッシュを試行

### 3.3 複数アカウント管理

- 複数のGmailアカウントおよびIMAPアカウントを登録可能
- 各アカウントは個別のディレクトリに隔離（profile, tokens/imap, labels, cache）
- アカウントIDはUUID形式で自動生成

### 3.4 アカウント切替

- ヘッダーのドロップダウンセレクタからアクティブアカウントを切替
- 切替時にキャッシュ済みサンプリング結果を自動復元
- 切替時に接続状態を自動チェック

### 3.5 アカウント一覧表示

- ヘッダーのセレクタおよび設定画面のアカウントタブで一覧表示
- 各アカウントのメールアドレス、プロバイダ（Gmail/IMAP）、接続状態を表示

### 3.6 接続状態表示

- アクティブアカウントの接続状態をChipインジケータで表示
- 緑色「有効」/ グレー「無効」
- アカウント切替時および起動時に自動チェック
- Gmail: APIのプロフィールエンドポイントで接続確認
- IMAP: imapflowで接続→ログアウトにより確認

### 3.7 ログアウト（アカウント削除）

- 選択アカウントの認証情報を削除し管理から除外
- アカウントディレクトリ全体を削除（profile, tokens, labels, cache含む）
- 削除されたアカウントがアクティブだった場合、次のアカウントに自動切替

### 3.8 前回アカウント復元

- 起動時に`state/app.json`の`lastAccountId`を参照
- 該当アカウントが存在する場合はそのアカウントを自動選択
- 存在しない場合は先頭のアカウントを選択
- アカウント切替のたびに`lastAccountId`を保存

---

## 4. ラベル管理

### 4.1 ラベル一覧取得

- Gmail: Gmail API（`users.labels.list`）からアカウントのラベル一覧を取得
- IMAP: imapflowの`client.list()`でメールボックス（フォルダ）一覧を取得
- システムラベル/フォルダとユーザーラベル/フォルダを区別

### 4.2 ツリー構造構築

- 階層ラベルを`/`で分割してツリー構造を構築
- 例: `Work/Projects/Active` → Work > Projects > Active
- 親ノードは自動生成され、展開/折りたたみ可能

### 4.3 複数選択

- チェックボックスで複数ラベルを選択可能
- 親ノードの選択で子ノードを一括選択/解除
- 部分選択時は不確定（indeterminate）状態を表示

### 4.4 ラベル更新

- ボタンクリックで最新ラベル一覧をGmail APIから再取得
- 既存の選択状態は可能な限り維持

### 4.5 選択状態保存

- アカウント別に選択ラベルを`labels.json`に保存
- デフォルトは`['INBOX']`
- メール取得時に選択ラベルを取得対象として使用

---

## 5. メール取得・キャッシュ

### 5.1 取得方式（モード）

| モード | FetchMode | 動作 |
| ------ | ------ | ------ |
| 日数指定（デフォルト） | `days` | グローバル設定の`samplingDays`日分のメールを取得 |
| 日付範囲指定 | `range` | 開始日〜終了日を指定して取得 |

各モードは独立したキャッシュファイルを持ち、モード切替時にそのモードのキャッシュから結果と条件を復元する。

### 5.2 取得フロー

```text
1. ユーザーが取得条件を設定（日数 or 日付範囲）
2. アカウント別の選択ラベルを読み込み
3. Gmail: Gmail API で messages.list を呼び出し / IMAP: imapflowでSEARCH実行
   - ラベル/フォルダフィルタ適用
   - 日付フィルタ（after/before / SINCE/BEFORE）適用
   - 既読/未読フィルタ（is:read/is:unread / SEEN/UNSEEN）適用
   - 最大取得件数制限
4. Gmail: messages.get で詳細取得 / IMAP: FETCH envelope+flags+uid で取得（進捗通知あり）
5. From別にグループ化（メールアドレス部分で同一判定）
6. 受信頻度を計算（件数 / サンプリング日数）
7. 結果をモード別キャッシュとして保存（sampling_{mode}.json + sampling_{mode}_meta.json）
8. Rendererに結果を返却
```

### 5.3 進捗表示

- 取得中はプログレスダイアログを表示
- current/total/messageをリアルタイム通知

### 5.4 モード別サンプリング結果保存

- 取得したメール情報をアカウント別・モード別キャッシュに保存
- メタ情報（モード、期間、取得日時、対象ラベル、件数）も保存
- サンプリング期間は画面に表示
- キャッシュファイル名: `sampling_{mode}.json` / `sampling_{mode}_meta.json`
  - 日数指定: `sampling_days.json` / `sampling_days_meta.json`
  - 期間指定: `sampling_range.json` / `sampling_range_meta.json`

### 5.5 キャッシュ復元

- 起動時およびアカウント切替時に現在のモードのサンプリング結果を自動復元
- 起動時にメールの自動取得は行わない（キャッシュからの復元のみ）
- モード切替時にそのモードのキャッシュが存在すれば結果と条件（日付範囲等）を復元
- キャッシュが存在しないモードに切替えた場合はリストを空にする

---

## 6. メール一覧・グループ化

### 6.1 グルーピングモード

テーブル上部のToggleButtonGroupで`From`/`Subject`/`Rule`モードを切替可能。モードはアカウント単位で`state/app.json`の`groupModes`（`Record<string, GroupMode>`）に保存され、アカウント切替時に復元される。

#### 6.1.1 From別グループ化（デフォルト）

- メールアドレス部分（`<>内`または全体）で同一判定してグループ化
- グループキーは`fromAddress`（小文字化されたメールアドレス）

#### 6.1.2 Subject別グループ化

- 件名を`toLowerCase().trim()`で正規化してグループ化
- 空件名は`(no subject)`として扱う
- グループキーは正規化された件名
- `displaySubject`: グループ内最新メールの件名（表示用）
- `fromSummary`: 代表Fromアドレス（2件以上は「他N件」を付与）
- `fromAddresses`: グループ内のdistinct Fromアドレス一覧
- AI判定キャッシュ・サンプリングデータはFrom/Subjectモード共通で再利用（SubjectグループはRenderer側で動的計算）

#### 6.1.3 Rule別グループ化

- アカウント別に定義されたルールに基づいてグループ化
- グループキーは`ruleKey`（ルール行番号ベース: "rule:0", "rule:1"）
- マッチ件数が0件のルールは表示しない

**ルール構文:**
```
subject:"正規表現"           # subject のみ検索
body:"正規表現"              # body (html/plain) を検索
"正規表現"                   # subject, body-html, body-plain 全て検索

# 同一行 = AND条件
subject:".*Delayed Mail.*" subject:".*retried.*"
subject:[".*delivery.*", ".*failed.*"]

# 複数行 = OR条件
subject:".*Undelivered.*"
subject:".*Undeliverable:.*"
```

- ルールはアカウント別に`accounts/{id}/rules.json`に保存
- ルール設定画面から編集可能（テキストエディタ形式）

### 6.2 From表示

- 同一アドレスの異なるFrom文字列（表示名+アドレス）をdistinctで収集
- 改行区切りで複数表示

### 6.3 表示項目

**Fromモード:**

| 項目 | 内容 |
| ------ | ------ |
| From | 表示名+アドレスの一覧（distinct） |
| 件数 | 各Fromからの受信メール数 |
| 頻度 | 受信頻度（件/日）= 件数 / サンプリング日数 |
| 代表件名 | 最新メールの件名 |
| 宣伝 | グループ内マーケティング度の範囲（最小-最大） |
| 迷惑 | グループ内迷惑度の範囲（最小-最大） |
| 詳細ボタン | 詳細ウィンドウを開くボタン |

**Subjectモード:**

| 項目 | 内容 |
| ------ | ------ |
| Subject | 件名（最新メールの件名を表示） |
| 件数 | 同一件名の受信メール数 |
| 頻度 | 受信頻度（件/日）= 件数 / サンプリング日数 |
| 参考From | 代表Fromアドレス（複数は「他N件」付与） |
| 宣伝 | グループ内マーケティング度の範囲（最小-最大） |
| 迷惑 | グループ内迷惑度の範囲（最小-最大） |
| 詳細ボタン | 詳細ウィンドウを開くボタン |

**Ruleモード:**

| 項目 | 内容 |
| ------ | ------ |
| ルール | ルール文字列（正規表現パターン） |
| 件数 | ルールにマッチするメール数 |
| 頻度 | 受信頻度（件/日）= 件数 / サンプリング日数 |
| 参考From | 最多送信者のFromアドレス |
| 参考件名 | 最新メールの件名 |
| 宣伝 | グループ内マーケティング度の範囲（最小-最大） |
| 迷惑 | グループ内迷惑度の範囲（最小-最大） |
| 詳細ボタン | 詳細ウィンドウを開くボタン |

### 6.4 ソート機能

以下のカラムでソート可能（昇順/降順切替）:

- 件数順
- 頻度順
- アルファベット順（Fromモード: Fromアドレス / Subjectモード: 件名）
- 最新受信日順

### 6.5 検索・フィルタ

- Fromモード: From名/ドメインでテキスト検索（大文字小文字不問）
- Subjectモード: 件名/差出人でテキスト検索（大文字小文字不問）
- AI判定結果のマーケティング度/迷惑度の範囲スライダーでフィルタリング
  - スライダー範囲外のグループを非表示
  - AI未判定のグループはフィルタ対象外（常に表示）

---

## 7. 詳細表示

### 7.1 詳細ウィンドウ

- From/Subjectグループの[>]ボタンでモーダレスポップアップウィンドウを開く
- メインウィンドウと同一のRendererアプリケーションを使用
- URLパラメータ`?detail=1`で詳細ビューモードに切り替え
- 各ウィンドウはFromモードでは`fromAddress`、Subjectモードでは`displaySubject`をキーとして管理

### 7.2 複数ウィンドウ対応

- 異なるグループの詳細を複数同時に表示可能
- 同一キーの詳細ウィンドウが既に開いている場合はフォーカスのみ

### 7.3 メール一覧

- 選択したグループの全メールを日時・件名・AI判定結果で一覧表示
- グループ全体のAI判定値の範囲（マーケティング度・迷惑度）をヘッダーに表示

### 7.4 本文表示

- 左リストでメール選択時に右パネルに本文を表示
- Gmail: Gmail API（`messages.get` format=full）で本文をオンデマンド取得
- IMAP: imapflowでFETCH BODYにより本文を取得（MIME解析でテキスト抽出）
- 4モード切替（ToggleButtonGroup）:
  - HTML: HTMLソースをそのままテキスト表示
  - HTML(テキスト): HTMLから`<body>`内容を抽出しタグ除去したテキスト表示
  - PLAIN: プレーンテキスト表示
  - RAW: ヘッダを含むメール全体の生データ表示（format=raw）
- HTMLが存在しない場合: HTML / HTML(テキスト) ボタンを非表示
- PLAINが存在しない場合: PLAIN ボタンを非表示
- 全モードともテキスト表示（iframe/webview不使用、pre-wrap + monospace）

### 7.5 HTML→テキスト変換

- `<body>`タグ内容を抽出（bodyがない場合は全体を対象）
- `<style>` / `<script>` ブロック除去
- `<br>` → 改行、`</p>` → 二重改行、`</div>` / `</tr>` / `</li>` → 改行
- HTMLタグ除去、HTMLエンティティ（`&amp;` `&lt;` `&gt;` `&quot;` `&nbsp;` `&#数値;`）デコード
- 連続空白圧縮、行頭行末空白除去、3行以上の連続空行を2行に圧縮

### 7.6 添付ファイル表示

- メール選択時に生ソース（rawBodies）をMIMEパースし、添付ファイル情報を動的に抽出
- ヘッダー部（件名・差出人・日時・宛先）の下、本文切替ボタンの上に添付ファイル一覧を表示
- 各添付ファイルについてファイル名・推定サイズ・MIMEタイプを表示
- RFC 2047 / RFC 2231 エンコードされたファイル名をデコード
- 添付がない場合はセクション自体を非表示

### 7.7 メール属性表示

- 各メールの重要マーク状態をアイコン表示（PriorityHighIcon）
- 各メールのスター状態をアイコン表示（StarIcon/StarBorderIcon）
- 個別メールのマーケティング度・迷惑度スコアを表示

---

## 8. 削除機能

### 8.1 削除対象選択

- グルーピングモードに応じてFromグループ/Subjectグループ単位でチェックボックスにより選択
- 全選択/全解除にも対応
- モード切替時に選択状態はクリアされる

### 8.2 一括削除

- **Fromモード**: 選択したFromグループの送信元アドレスで**全期間のメールを検索**し、ゴミ箱へ移動
  - Gmail: API検索（`from:{address}`）で該当メールを網羅的に取得
  - IMAP: 全フォルダ（Trash/Junk除く）でSEARCH FROM実行
- **Subjectモード**: 選択したSubjectグループの件名で**全期間のメールを検索**し、ゴミ箱へ移動
  - Gmail: API検索（`subject:"{subject}"`）で該当メールを網羅的に取得
  - IMAP: 全フォルダ（Trash/Junk除く）でSEARCH SUBJECT実行
- **Ruleモード**: 選択したRuleグループのルールにマッチする**全期間のメールを検索**し、ゴミ箱へ移動
  - Gmail/IMAP共通: 全メールを取得し、クライアント側でルールによる正規表現マッチングを実行
  - Subject/Bodyパターンに応じてマッチング
- サンプリング期間に限定せず、全期間が対象
- 削除方式はゴミ箱移動（Gmail: `messages.trash` / IMAP: `\\Trash`フォルダへMOVE）に固定
- バッチ処理（20件並列）で効率的に実行し、進捗をリアルタイム通知

### 8.3 除外条件

- 削除設定に基づき以下を除外:
  - `excludeImportant = true`: 重要マーク付きメールを除外（IMAP: `\\Flagged`フラグ）
  - `excludeStarred = true`: スター付きメールを除外（IMAP: `\\Flagged`フラグ）
- 除外されたメールは削除件数から除外件数に計上

### 8.4 確認ダイアログ

- 一括削除実行前に確認ダイアログを表示（赤色 error severity）
- 期間削除実行前に確認ダイアログを表示（オレンジ色 warning severity）
- グループ数を明示
- Fromモード/Subjectモードに応じた確認メッセージを表示

### 8.5 削除結果表示

- ステータスバーに結果サマリを表示:
  - 削除件数（ゴミ箱移動成功）
  - 除外件数（重要/スター付きで除外）
  - エラー件数
- 削除完了後に再取得確認ダイアログを表示:
  - 削除結果メッセージ + 「再取得しますか？」
  - 「はい」: 現在のfetchMode（日数/期間）を保持して再取得実行
  - 「いいえ」: ダイアログを閉じるのみ
  - 一括削除・期間削除の両方で共通

### 8.6 期間削除

- 選択したグループの**サンプリング済みメールのみ**をゴミ箱へ移動
- API検索を行わず、Renderer側で保持するメッセージIDを直接指定して削除（IMAP: フォルダパス:UID形式）
- Renderer側で削除設定（`excludeImportant`/`excludeStarred`）によるフィルタリングを実行
- 除外条件適用後にメッセージが0件の場合はステータスバーにメッセージを表示し中断
- バッチ処理（20件並列）で効率的に実行
- From/Subject/Ruleモード共通の動作

### 8.7 ゴミ箱閲覧機能

メイン画面のアクションバーに「ゴミ箱を見る」ボタンを配置。クリックするとゴミ箱ウィンドウを開く。

#### 8.7.1 ゴミ箱ウィンドウ

- 詳細ウィンドウと同様のモーダレスポップアップウィンドウ
- 左パネル: メール一覧（チェックボックス付き）
- 右パネル: 選択メールの本文表示（本文はAPIからオンデマンド取得）

#### 8.7.2 操作ボタン

| ボタン | 動作 |
| ------ | ------ |
| 全件チェック | 全メールを選択状態にする |
| 全チェック解除 | 全メールの選択を解除する |
| チェック分を削除 | 選択されたメールのみ完全削除（確認ダイアログあり） |
| ゴミ箱を空にする | チェック状態に関わらず全件完全削除（確認ダイアログあり） |

#### 8.7.3 ゴミ箱メール取得

- Gmail: `labelIds='TRASH'`でメール取得
- IMAP: `findTrashFolder()`でゴミ箱フォルダを特定し取得

#### 8.7.4 完全削除

- Gmail: `DELETE /messages/{id}`で完全削除
- IMAP: `\Deleted`フラグ付与 + EXPUNGE

---

## 9. Ollama AI判定

### 9.1 自動判定ボタン

- グループ一覧画面のアクションバーに配置
- Ollama設定（host, model）が未設定の場合はボタン無効化

### 9.2 判定対象・方法

- 件名（必須）とメール本文を対象に判定
- 本文が未取得の場合はGmail API/IMAPでオンデマンド取得
- 本文選択の優先順位:
  1. HTML（`<body>`タグ内部を抽出、HTMLタグは保持）
  2. HTML `<body>`内部が空の場合はPlain textにフォールバック
  3. 両方なければ件名のみで判定
- 選択された1つの本文のみ送信（両方は送らない）
- 本文は先頭4000文字を使用
- HTMLタグは分類シグナル（トラッキングピクセル、ボタン、テーブルレイアウト等）として有用なため除去しない
- HTML本文のコンパクト化（外部ライブラリ不使用、正規表現ベース）:
  - HTMLコメント除去
  - 改行 → スペース1個
  - タブ → スペース1個
  - タグ間の空白除去（`><`に正規化）
  - 連続スペースの圧縮
  - 属性（style, class, id, href, src等）は保持
- Plain textはコンパクト化しない（改行は意味を持つため保持）
- 本文セクションは固有の区切り文字列で囲む（例: `<<<EMAIL_BODY>>>` / `<<<END_EMAIL_BODY>>>`）
- Plain textでも同様の区切りを使用（改行を含む複数行がそのまま入る）

### 9.3 判定スケール

| 判定項目 | 範囲 | 説明 |
| ------ | ------ | ------ |
| マーケティング度 | 0-10 | 0=マーケティング性なし、10=純粋なマーケティング/販促 |
| 迷惑メール度 | 0-10 | 0=正当なメール、10=明らかなスパム/ジャンク |

### 9.4 AI判定フロー

```text
Phase 1: 準備（本文取得・ボディ選択・キャッシュ確認）
1. ユーザーが「自動判定」ボタンをクリック
2. 現在のモード（days/range）のサンプリングキャッシュからメッセージを取得
2a. AI自動判定設定（allowedLanguages）を読み込み
3. 全メッセージについて本文・生ソースを取得（サンプリングキャッシュから読み込み、外部接続なし）
   - Gmail/IMAP共通: sampling_{mode}.json内のbodyParts/rawBodiesから取得
   - text/plain と text/html を個別に抽出（EmailBodyParts）
3a. 生ソース（rawBodies）をMIMEパースし添付ファイル情報（ファイル名・サイズ・MIMEタイプ）を抽出
4. ボディ選択: HTML <body>内部（非空） > plain text > なし
5. 選択されたボディを先頭4000文字に切り詰め
6. 件名+切り詰め後ボディ+許可言語+添付ファイル情報のSHA-256ハッシュを計算
7. キャッシュヒット: 既存の判定結果を使用（Ollamaリクエストスキップ）

Phase 2: AI判定（キャッシュミス分のみ）
8. キャッシュミス:
   a. プロンプトを構築（件名+選択ボディ+添付ファイル情報、HTMLの場合は構造的シグナルの注意書き付き、許可言語ヒント付き）
      - 添付ファイルがある場合: ファイル名・MIMEタイプ・サイズをプロンプトに含め、実行ファイル(.exe等)やアーカイブ(.zip等)はスパム/フィッシングの強い指標として、PDF/画像はマーケティングの指標としてAIに伝達
   b. Ollama APIに判定リクエスト送信
   c. JSON形式で応答を受信・パース
   d. スコアを0-10の範囲にクランプ
9. 設定された同時処理数（concurrency）でバッチ並列実行
10. 判定結果をグローバルキャッシュに保存（ai_judgments.json）
11. 判定結果をモード別サンプリングキャッシュに反映（sampling_{mode}.json）
12. FromGroupのAIスコア範囲を再計算
13. 進捗を逐次通知（プログレスダイアログ表示）
14. キャンセルボタンで中断可能（AbortControllerにより進行中のOllamaリクエストも即座に中断）
```

判定対象は現在選択中のモードのメッセージのみ。判定完了時にモード別キャッシュファイルにAIスコアを書き戻すことで、モード切替時にも判定結果が保持される。

### 9.5 コンテンツベースキャッシュ

- キー: Ollamaに送信する内容に基づくSHA-256ハッシュ値
  - ハッシュ対象: `subject\n{選択・切り詰め後のボディ}`
  - 許可言語が設定されている場合: `\nlang:{ソート済み言語コード}`をハッシュ入力に追加
  - ボディはHTML `<body>`内部（優先）またはplain text（フォールバック）の先頭4000文字
- 値: マーケティング度、迷惑度、判定日時（`judgedAt`）
- スコープ: グローバル（アカウント/From非依存）
- 同一コンテンツは再判定不要
- 有効期限: 30日（`judgedAt`から起算、読み込み時に期限切れエントリを自動削除）

### 9.6 範囲フィルタ

- マーケティング度・迷惑度それぞれでスライダーによる範囲指定
- 範囲外のFromグループを非表示
- リセットボタンで全範囲に戻す

### 9.7 AI判定キャッシュクリア

- AI判定結果のキャッシュのみを削除する機能
- 設定画面のデータ管理タブから実行可能

---

## 10. GCP JSONインポート

### 10.1 ファイル選択

- ファイルダイアログでcredentials.json（GCP OAuth2クレデンシャルファイル）を選択

### 10.2 自動パース

- JSON構造を解析し、以下のフィールドを自動抽出:
  - `client_id` → clientId
  - `client_secret` → clientSecret
  - `project_id` → projectId
- 以下の3つのJSON構造に対応:
  - `json.installed`（インストール済みアプリケーション形式）
  - `json.web`（Webアプリケーション形式）
  - 直接フィールド（フォールバック）

### 10.3 検証

- 不正なJSON形式の場合はエラー表示
- `client_id`または`client_secret`が欠落している場合はエラー表示

### 10.4 手動編集併用

- JSONインポート後も各入力欄（clientId, clientSecret, projectId）の手動編集が可能
- 設定状態を緑色のChipで「設定済み」と表示

---

## 11. 設定項目

### 11.1 一般設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| 言語 | select | 初回起動時にOS検出 | ja / en（初回起動時に`app.getLocale()`でOS言語を検出し保存） |
| テーマ | select | system | system / light / dark（`system`はOS設定に毎回追従） |

- 言語: 初回起動時（`settings/general.json`が存在しない場合）にOS言語を検出し保存。2回目以降は保存値を使用。
- テーマ: デフォルト`system`。`system`選択時は起動のたびにOS設定（`nativeTheme.shouldUseDarkColors`）に従う。`light`/`dark`選択時は設定値を優先。

### 11.2 メール取得設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| サンプリング日数 | number | 30 | デフォルト取得日数 |
| 最大取得件数 | number | 1000 | 1回の取得上限 |
| 既読/未読フィルタ | select | all | all / unread / read |

### 11.3 削除設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| 重要メール除外 | boolean | true | 重要マーク付きメールを削除対象から除外 |
| スター付き除外 | boolean | true | スター付きメールを削除対象から除外 |

削除方式はゴミ箱移動に固定。一括削除時に確認ダイアログを固定表示。

### 11.4 Ollama設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| Ollamaホスト | string | `http://localhost:11434` | OllamaサーバーURL |
| モデル | select | - | 利用可能モデル一覧から選択 |
| 接続テスト | button | - | 接続確認ボタン（成功/失敗を表示） |
| タイムアウト | number | 180 | API応答タイムアウト秒数（0で無制限） |
| 同時処理数 | number | 1 | 並列判定数 |

### 11.5 AI自動判定設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| 普段受信する言語 | multi-checkbox | すべて（空配列） | 選択した言語以外のメールはスパム判定が高くなる |

- 言語リスト: ja, en, zh, ko, es, fr, de, pt, ru, ar, it, th, vi（13言語）
- 「すべて」選択時（空配列）: 言語によるスパム判定ヒントをOllamaに送信しない
- 特定言語選択時: Ollamaプロンプトに言語ヒントを英語フルネームで追加（例: `Japanese, English`）
- 言語設定変更時にAI判定キャッシュのハッシュが変わるため、再判定が必要

### 11.6 GCP API設定（グローバル）

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| GCP認証JSONインポート | file-select | - | credentials.jsonを選択して自動設定 |
| クライアントID | string | - | GCP OAuth2クライアントID（自動/手動） |
| クライアントシークレット | string | - | GCP OAuth2シークレット（自動/手動、暗号化保存） |
| プロジェクトID | string | - | GCPプロジェクトID（自動/手動） |
| 設定状態 | display | - | GCP設定の完了状態表示（緑色Chip） |

### 11.7 アカウント管理

| 項目 | 型 | 説明 |
| ------ | ------ | ------ |
| 登録アカウント一覧 | table | プロバイダ別（Gmail→IMAP）にソート表示。メールアドレス、プロバイダ、接続状態、操作ボタン |
| アカウント追加（Gmail） | button | GCP設定を使用して新規OAuth認証 |
| アカウント追加（IMAP） | button | IMAP接続設定ダイアログを表示 |
| IMAP設定編集 | icon button | IMAPアカウントの接続設定を編集（設定アイコン、接続テスト付き） |
| ログアウト | button | 選択アカウントの認証情報削除・管理から除外 |

GmailアカウントにはGCP API設定が必要。IMAPアカウントはGCP設定不要で直接追加可能。
アカウント一覧はGmailアカウント（メアド順）→IMAPアカウント（メアド順）の順にソートされる。

### 11.7.1 アカウント別設定

| 項目 | 型 | デフォルト | 説明 |
| ------ | ------ | ------ | ------ |
| 取得対象ラベル | tree-multiselect | INBOX | ラベルをツリー表示し複数選択可能 |

### 11.8 データ管理（グローバル）

| 項目 | 型 | 説明 | 確認 |
| ------ | ------ | ------ | ------ |
| AI判定キャッシュクリア | button | AI判定結果キャッシュのみを削除 | 確認ダイアログあり |
| 全キャッシュクリア | button | 全アカウントのキャッシュディレクトリ・AI判定結果を削除 | 警告ダイアログあり |
| 設定エクスポート | button | JSON形式で設定出力（認証情報除く） | なし |
| 設定インポート | button | JSON形式で設定読込 | なし |
| アカウントエクスポート | button | 全アカウントデータをJSON形式で出力（認証情報含む） | なし |
| アカウントインポート | button | アカウントデータをJSON形式で読込 | なし |

**アカウントエクスポート内容:**

- 暗号化キー（base64エンコード）
- GCP API設定（clientSecret含む）
- 各アカウント: プロファイル、ラベル設定、ルール設定
- Gmailアカウント: OAuthトークン
- IMAPアカウント: 接続設定（パスワード含む）

**注意事項:**

- エクスポートファイルは別端末へのインポート用に平文で出力される
- 暗号化キーも含まれるため、エクスポートファイルの取扱いに注意
- インポート時: ローカルに暗号化キーがない場合はエクスポートのキーを使用
- インポート時: ローカルに暗号化キーがある場合はローカルキーを優先（エクスポートのキーは無視）

---

## 12. 画面構成

### 12.1 メイン画面

Fromモード表示例:

```text
+-------------------------------------------------------------------------------------+
|  Mail Valet                                                                [設定]   |
+-------------------------------------------------------------------------------------+
|  [user1@gmail.com v]  (接続中)                                                      |
+-------------------------------------------------------------------------------------+
|  サンプリング期間: 2024/01/01 - 2024/01/31                                           |
|  取得条件: [日数指定|期間指定] [30日] [最新の情報を取得]                               |
+-------------------------------------------------------------------------------------+
|  AI判定フィルタ: 宣伝 [0----10] 迷惑 [0----10] [リセット]                             |
+-------------------------------------------------------------------------------------+
|  操作モード: [From|Subject]  [From/ドメインで検索...]                                 |
+-------------------------------------------------------------------------------------+
|  [ ] | From                        | 件数 | 頻度    | 代表件名     | 宣伝 | 迷惑 |   |
|------|------------------------------|------|---------|-------------|------|------|---|
|  [x] | Marketing Team <news@...>   |   45 | 1.5/日  | Weekly News | 7-9  | 2-4  |[>]|
|      | Newsletter <news@...>       |      |         |             |      |      |   |
|  [ ] | alert@bank.com              |   12 | 0.4/日  | お取引通知   | 0-2  | 0-1  |[>]|
+-------------------------------------------------------------------------------------+
|  [自動判定] [期間で削除 (1)] [一括削除 (1)]                                             |
+-------------------------------------------------------------------------------------+
|  ステータス: キャッシュから復元 - 146件 / 3グループ                                    |
+-------------------------------------------------------------------------------------+
```

Subjectモード表示例:

```text
+-------------------------------------------------------------------------------------+
|  操作モード: [From|Subject]  [件名/差出人で検索...]                                   |
+-------------------------------------------------------------------------------------+
|  [ ] | Subject                    | 件数 | 頻度    | 参考From | 宣伝 | 迷惑 |        |
|------|----------------------------|------|---------|----------|------|------|--------|
|  [x] | Weekly Newsletter          |   45 | 1.5/日  | news@... | 7-9  | 2-4  |  [>]   |
|  [ ] | お取引通知                  |   12 | 0.4/日  | alert@.. | 0-2  | 0-1  |  [>]   |
+-------------------------------------------------------------------------------------+
```

構成要素:

- **タイトルバー**: アプリ名、設定ボタン、ウィンドウ操作ボタン（フレームレス）
- **アカウントセレクタ**: ドロップダウンでアカウント切替、接続状態Chip、追加ボタン
- **取得コントロール**: 日数/期間モード切替（キャッシュ復元あり）、日付入力、「最新の情報を取得」ボタン
- **AIフィルタバー**: 宣伝/迷惑の範囲スライダー、リセットボタン
- **グルーピングモード切替**: From/Subjectの切替ToggleButtonGroup
- **グループテーブル**: チェックボックス、From名またはSubject、件数、頻度、宣伝/迷惑スコア範囲、詳細ボタン
- **アクションバー**: 自動判定ボタン、期間で削除ボタン（warning色、選択数表示）、一括削除ボタン（error色、選択数表示）
- **ステータスバー**: 状態メッセージ

### 12.2 詳細ポップアップウィンドウ（モーダレス・複数表示可）

フレームレスウィンドウ（メインウィンドウと同じスタイル）。左リスト＋右コンテンツの横分割レイアウト。

```text
+---------------------------------------------------------------------+
| news@svc.com (45件) 宣伝:7-9 迷惑:2-4          [_][□][X]            |
+---------------------------+-----------------------------------------+
| !★    01/31 09:15        | Subject: Weekly Newsletter              |
| Example Inc <norep...     | From: Example Inc <noreply@example.com> |
| Weekly Newsletter         | Date: 2024/01/31 09:15                  |
| 宣伝:8 迷惑:2             | To: user@gmail.com                      |
|---------------------------|   [HTML] [HTML(テキスト)] [PLAIN] [RAW]  |
|        01/24 09:12        |-----------------------------------------|
| Example Inc <norep...     | HTMLレンダリング or テキスト表示           |
| Weekly Newsletter         |                                         |
| 宣伝:8 迷惑:2             |                                         |
+---------------------------+-----------------------------------------+
```

- タイトルバー: フレームレス、ドラッグ領域、最小化/最大化/閉じるボタン（Macは左寄せ信号ボタン対応）
- 左パネル（280px固定）: メールリスト（1セルに重要/スターアイコン・日時・From・件名・AIスコア）
- 右パネル（可変幅）: 選択メールの詳細（Subject・From・Date・To・本文）
- 本文表示は4モード切替（全モードともテキスト表示、iframe/webview不使用）:
  - HTML: HTMLソースをそのままテキスト表示
  - HTML(テキスト): HTMLからbody内容を抽出しタグ除去したテキスト表示
  - PLAIN: プレーンテキスト表示
  - RAW: 生メールデータ表示
- HTMLが存在しない場合はHTML/HTML(テキスト)ボタンを非表示、PLAINが存在しない場合はPLAINボタンを非表示
- 右パネルでは全項目を省略せず全文表示

### 12.3 設定画面（ダイアログ）

```text
+----------------------------------------------------------+
|  設定                                          [閉じる]   |
+----------------------------------------------------------+
|  [一般][取得][削除][Ollama][自動判定][GCP API][アカウント][データ] |
+----------------------------------------------------------+
|  タブの内容がここに表示される                              |
+----------------------------------------------------------+
|                                       [適用] [キャンセル]  |
+----------------------------------------------------------+
```

- ドラフト保存パターン: ダイアログオープン時に全設定を読み込み、編集はメモリ上のドラフトを更新
- 「適用」ボタン: 全設定を一括保存し、テーマ・言語を反映して閉じる
- 「キャンセル」ボタン / 閉じるボタン: 変更を破棄して閉じる（プレビューなし）
- テーマ・言語の変更は適用ボタン押下時にのみ反映（即時プレビューしない）
- テーマの`system`選択時はメインプロセスで`nativeTheme.shouldUseDarkColors`を参照して解決

8つのタブで構成:

1. 一般（言語、テーマ）
2. メール取得（日数、件数、フィルタ）
3. 削除（除外設定）
4. Ollama（ホスト、モデル、接続テスト、タイムアウト、並列数）
5. 自動判定（普段受信する言語の選択）
6. GCP API（JSONインポート、認証情報）
7. アカウント（一覧、追加、ログアウト、ラベル設定）
8. データ（キャッシュクリア、設定エクスポート/インポート、リセット）

---

## 13. 多言語対応

### 13.1 言語検出

- 初回起動時: Main側で`app.getLocale()`によりOS言語を検出し、設定ファイルに保存
  - `ja`で始まる場合は日本語（`ja`）、それ以外は英語（`en`）
- 2回目以降: 保存済みの設定値を使用（OS言語の再検出は行わない）
- 設定画面から明示的に言語を変更可能

### 13.2 言語切替

- 設定画面から日本語/英語を選択可能
- 切替は即時反映（ページリロード不要）

### 13.3 翻訳リソース

| 言語 | ファイル |
| ------ | ------ |
| 日本語 | `src/renderer/i18n/locales/ja.ts` |
| 英語 | `src/renderer/i18n/locales/en.ts` |

翻訳カテゴリ: common, account, imap, fetch, filter, list, rule, trash, action, delete, status, detail, settings, label, data

拡張可能な設計により、新しい言語ファイルの追加で対応言語を増やせる。

---

## 14. テーマ

- MUI v7のテーマシステムを使用
- `system` / `light` / `dark`の3モードをサポート（`AppTheme`型）
- `system`: 起動のたびに`nativeTheme.shouldUseDarkColors`でOS設定を参照し`light`/`dark`に解決
- `light` / `dark`: 設定値をそのまま使用
- テーマ変更時にメインプロセスの`nativeTheme.themeSource`も同期
- `createTheme({ palette: { mode } })`でMUIコンポーネントに適用
- Renderer初期化時のテーマフラッシュ防止: AppInfo取得前は`window.matchMedia('(prefers-color-scheme: dark)')`をフォールバックとして使用

---

## 15. データ保存構造

### 15.1 ディレクトリ構造

保存場所: `~/.mailvalet/`

```text
~/.mailvalet/
  +-- settings/
  |     general.json          # 一般設定（言語、テーマ）
  |     fetch.json            # メール取得設定
  |     delete.json           # 削除設定
  |     ollama.json           # Ollama設定
  |     ai-judgment.json      # AI自動判定設定（許可言語）
  |     gcp.json              # GCP API設定（clientSecret暗号化）
  |     encryption-key.bin    # 暗号化キー（バイナリ32バイト）
  |
  +-- accounts/
  |     +-- {account_id_1}/
  |     |     profile.json    # メールアドレス、表示名、プロバイダ
  |     |     tokens.json     # OAuthトークン（暗号化）- Gmailのみ
  |     |     imap.json       # IMAP接続設定（パスワード暗号化）- IMAPのみ
  |     |     labels.json     # 選択ラベル/フォルダ設定
  |     |     rules.json      # ルール設定（Ruleモード用）
  |     |     +-- cache/
  |     |           sampling_days.json       # サンプリング結果（日数指定モード）
  |     |           sampling_days_meta.json  # サンプリングメタ（日数指定モード）
  |     |           sampling_range.json      # サンプリング結果（期間指定モード）
  |     |           sampling_range_meta.json # サンプリングメタ（期間指定モード）
  |     |
  |     +-- {account_id_2}/
  |           ...
  |
  +-- cache/
  |     ai_judgments.json     # AI判定キャッシュ（件名+本文ハッシュをキー、グローバル）
  |
  +-- state/
  |     app.json              # 前回選択アカウント、ウィンドウサイズ等
  |
  +-- logs/
        app.log               # アプリケーションログ
```

### 15.2 プラットフォーム別パス

| OS | パス |
| ------ | ------ |
| Windows | `C:\Users\{username}\.mailvalet\` |
| macOS | `/Users/{username}/.mailvalet/` |
| Linux | `/home/{username}/.mailvalet/` |

---

## 16. セキュリティ

### 16.1 暗号化

| 対象ファイル | 対象フィールド | アルゴリズム |
| ------ | ------ | ------ |
| gcp.json | clientSecret | AES-256-GCM |
| tokens.json | accessToken, refreshToken | AES-256-GCM |
| imap.json | password | AES-256-GCM |

- 暗号化キー: `settings/encryption-key.bin`に32バイトのバイナリキーとして保存
  - 新規インストール: ランダムな32バイトキーを生成し保存
  - 既存データからのマイグレーション: レガシー方式（ホスト名+ユーザー名）で復号 → 新しいランダムキーを生成 → 新キーで再暗号化して保存
  - 以降: 保存済みキーを使用（ホスト名・ユーザー名には一切依存しない）
- IV: 暗号化ごとにランダム16バイト生成
- 暗号文はIV + AuthTag + CipherTextの結合形式で保存

### 16.2 プロセス分離

- contextIsolation: 有効
- nodeIntegration: 無効
- sandbox: 有効
- contextBridge経由でのみRendererからMainにアクセス可能

---

## 17. IPC通信

### 17.1 通信パターン

| パターン | 用途 | 例 |
| ------ | ------ | ------ |
| invoke/handle | 同期的リクエスト/レスポンス | 設定取得、アカウント操作 |
| send/on | 一方向イベント通知 | 進捗通知、ウィンドウ操作 |

### 17.2 主要チャネル一覧

| カテゴリ | チャネル数 | 説明 |
| ------ | ------ | ------ |
| app | 3 | アプリ情報、テーマ/言語設定 |
| window | 4 | ウィンドウ操作（最小化、最大化、閉じる） |
| settings | 13 | 各種設定のCRUD |
| accounts | 14 | アカウント管理、ラベル管理、ルール管理、IMAP追加・接続テスト・設定取得・設定更新 |
| mail | 10 | メール取得、本文/生データ/ボディパーツ取得、From一括削除、Subject一括削除、Rule一括削除、Ruleグループ構築、メッセージID指定削除、キャッシュ取得（プロバイダ振り分け） |
| ollama | 4 | AI判定、接続テスト、モデル一覧 |
| data | 4 | キャッシュクリア、設定エクスポート/インポート |
| detail | 2 | 詳細ウィンドウ |
| trash | 5 | ゴミ箱ウィンドウ操作、取得、選択削除、全削除 |
| event | 3 | 進捗イベント |
| state | 2 | アプリ状態保存/復元 |

---

## 18. 状態管理

### 18.1 Renderer側（Zustand）

| ストア | 役割 | 主要な状態 |
| ------ | ------ | ------ |
| useAppStore | アプリ全体 | appInfo, isDetailView, settingsOpen, statusMessage |
| useAccountStore | アカウント管理 | accounts, activeAccountId, isConnected |
| useEmailStore | メール/AI判定 | samplingResult, fromGroups, subjectGroups, groupMode, selectedGroupKeys, aiProgress, sort, filter, fetchMode |

### 18.2 Main側（ファイルベース）

- 設定変更は即座にJSONファイルに書き込み
- ウィンドウサイズ変更はresized/movedイベントで`state/app.json`に保存
- 前回選択アカウントは`state/app.json`の`lastAccountId`で復元

---

## 19. キャッシュ戦略

| データ | スコープ | 保存先 | クリア条件 |
| ------ | ------ | ------ | ------ |
| サンプリング結果（本文・生ソース含む） | アカウント別・モード別 | accounts/{id}/cache/sampling_{mode}.json | 同モードでの再取得時、全キャッシュクリア時 |
| サンプリングメタ | アカウント別・モード別 | accounts/{id}/cache/sampling_{mode}_meta.json | 同モードでの再取得時、全キャッシュクリア時 |
| AI判定結果 | グローバル | cache/ai_judgments.json | AI判定キャッシュクリア時、全キャッシュクリア時 |

---

## 20. エラーハンドリング

| シナリオ | 動作 |
| ------ | ------ |
| Ollama未起動/未設定 | 接続テスト失敗表示、自動判定ボタン無効化 |
| トークン期限切れ（Gmail） | 自動リフレッシュ（60秒バッファ）、401時にリトライ |
| リフレッシュ失敗（Gmail） | 再認証を促すメッセージ |
| API制限超過（Gmail） | エラーメッセージ表示 |
| IMAP接続失敗 | 接続テスト失敗表示、アカウント追加を中断 |
| IMAPフォルダアクセス不可 | 当該フォルダをスキップして続行 |
| IMAPトラッシュフォルダ未検出 | `\\Trash` specialUse → 一般名（Trash, Deleted Items等）でフォールバック |
| ネットワーク切断 | 接続状態インジケータの更新、キャッシュからの復元は可能 |
| 暗号化キー未移行 | マシン移行時に暗号化キーファイルがない場合、アカウントエクスポート/インポート機能で移行可能 |
| 削除エラー | 削除処理のエラー件数をステータスバーに表示 |
| GCP設定未完了 | Gmailアカウント追加不可（IMAPは影響なし） |

---

## 21. 非機能要件

| カテゴリ | 要件 |
| ------ | ------ |
| セキュリティ | OAuth2トークン・クライアントシークレット・IMAPパスワードのAES-256-GCM暗号化保存 |
| 拡張性 | IPCハンドラのプロバイダ振り分けパターン、多言語リソースの追加が容易な構造 |
| 可用性 | オフライン時のエラーハンドリング、Ollama未起動時の適切な表示 |
| データ保存 | `~/.mailvalet/` 配下に統一保存 |
| マルチアカウント | アカウント間のデータ分離、切替時の状態保持 |
| ポータビリティ | `~/.mailvalet/` をコピーすることで設定移行可能（要再認証） |
| 状態復元 | 起動時に前回状態（アカウント、ウィンドウサイズ）を復元 |

---

## 22. 固定仕様

| 項目 | 固定値 |
| ------ | ------ |
| 削除方式 | ゴミ箱へ移動（Gmail: messages.trash / IMAP: \\Trashフォルダへmove） |
| 削除確認 | 一括削除時に1回表示 |
| ウィンドウサイズ | 自動記憶・復元（resized/movedイベント） |
| 起動時データ取得 | しない（キャッシュから復元） |
| テーマ検出 | デフォルト`system`（OS追従）。`light`/`dark`指定時は設定値優先 |
| 言語検出 | 初回起動時にOS設定から検出・保存（以降は設定値を使用、手動切替可能） |
| 一括削除範囲 | 選択したFrom/Subject/Ruleの全期間メールを検索・削除（サンプリング期間に限定しない） |
| 期間削除範囲 | サンプリング済みメッセージIDを直接指定して削除（サンプリング期間内のみ） |
| グルーピングモード保存 | アカウント単位でFrom/Subject/Ruleモードを`state/app.json`の`groupModes`に保存 |
| ゴミ箱完全削除 | ゴミ箱ウィンドウから選択削除または全件削除（確認ダイアログあり） |
