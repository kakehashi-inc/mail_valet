# テーブル定義

本アプリケーションはファイルベースのJSON保存方式を採用しており、RDBは使用しない。
各JSONファイルをテーブルに相当するデータモデルとして定義する。

保存先ルート: `~/.mailvalet/`

---

## 1. settings/general.json - 一般設定

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|----------|------|
| language | `'ja' \| 'en'` | - | 表示言語。初回起動時にOS言語から検出して保存 |
| theme | `'system' \| 'light' \| 'dark'` | `'system'` | テーマ。systemはOSテーマに追従 |

---

## 2. settings/fetch.json - メール取得設定

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|----------|------|
| samplingDays | `number` | `30` | デフォルト取得日数 |
| maxFetchCount | `number` | `1000` | 1回の取得上限件数 |
| readFilter | `'all' \| 'unread' \| 'read'` | `'all'` | 既読/未読フィルタ |

---

## 3. settings/delete.json - 削除設定

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|----------|------|
| excludeImportant | `boolean` | `true` | 重要マーク付きメールを削除対象から除外 |
| excludeStarred | `boolean` | `true` | スター付きメールを削除対象から除外 |

---

## 4. settings/ollama.json - Ollama設定

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|----------|------|
| host | `string` | `'http://localhost:11434'` | OllamaサーバーURL |
| model | `string` | `''` | 使用するAIモデル名 |
| timeout | `number` | `180` | APIタイムアウト秒数（0で無制限） |
| concurrency | `number` | `1` | 並列判定数 |

---

## 5. settings/gcp.json - GCP API設定

| カラム名 | 型 | デフォルト | 説明 | 暗号化 |
|----------|-----|----------|------|--------|
| clientId | `string` | `''` | OAuth2クライアントID | - |
| clientSecret | `string` | `''` | OAuth2クライアントシークレット | AES-256-GCM |
| projectId | `string` | `''` | GCPプロジェクトID | - |

---

## 6. accounts/{account_id}/profile.json - アカウントプロフィール

| カラム名 | 型 | 説明 | リレーション |
|----------|-----|------|-------------|
| id | `string` | アカウントの一意識別子（UUID形式） | PK |
| email | `string` | メールアドレス | - |
| displayName | `string` | 表示名 | - |
| provider | `MailProviderId` | メールプロバイダ識別子（`'gmail'` \| `'imap'`） | - |

---

## 7. accounts/{account_id}/tokens.json - 認証トークン

| カラム名 | 型 | 説明 | 暗号化 |
|----------|-----|------|--------|
| accessToken | `string` | OAuth2アクセストークン | AES-256-GCM |
| refreshToken | `string` | OAuth2リフレッシュトークン | AES-256-GCM |
| expiresAt | `number` | トークン有効期限（UNIXタイムスタンプms） | - |

リレーション: `account_id` で `profile.json` と 1:1 対応

---

## 8. accounts/{account_id}/labels.json - ラベル選択設定

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|----------|------|
| selectedLabelIds | `string[]` | `['INBOX']` | 取得対象ラベルIDの配列 |

リレーション: `account_id` で `profile.json` と 1:1 対応

---

## 9. accounts/{account_id}/cache/sampling_{mode}.json - サンプリング結果

| カラム名 | 型 | 説明 |
|----------|-----|------|
| messages | `EmailMessage[]` | 取得したメール一覧 |
| fromGroups | `FromGroup[]` | From別グループ化結果 |
| periodStart | `string` | サンプリング開始日（ISO 8601） |
| periodEnd | `string` | サンプリング終了日（ISO 8601） |
| totalCount | `number` | 合計メール件数 |
| bodyParts | `Record<string, EmailBodyParts>` | メール本文キャッシュ（plain/html）。キー: メッセージID |
| rawBodies | `Record<string, string>` | メール生ソースキャッシュ。キー: メッセージID |

### EmailMessage 構造

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | `string` | メッセージID（Gmail: メッセージID / IMAP: `フォルダパス:UID`） |
| threadId | `string` | スレッドID（Gmail: スレッドID / IMAP: 空文字） |
| from | `string` | 送信者表示名+アドレス |
| fromAddress | `string` | 送信者メールアドレス（グループ化キー） |
| to | `string` | 宛先（Toヘッダー） |
| subject | `string` | 件名 |
| date | `string` | 受信日時（ISO 8601） |
| snippet | `string` | メールの概要テキスト（IMAP: 空文字） |
| labelIds | `string[]` | Gmail: ラベルIDの配列 / IMAP: フォルダパスの配列（通常1要素） |
| isImportant | `boolean` | Gmail: 重要マーク / IMAP: `\Flagged`フラグ |
| isStarred | `boolean` | Gmail: スター / IMAP: `\Flagged`フラグ |
| aiJudgment | `AIJudgment?` | AI判定結果（判定済みの場合） |

※ メール本文（plain/html）は `bodyParts` マップ、生ソースは `rawBodies` マップに格納。添付ファイル情報は `rawBodies` の生ソースからオンデマンドでパースして取得する（`parseAttachmentsFromRaw`）。

### EmailAttachmentInfo 構造（rawパース結果）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| filename | `string` | 添付ファイル名 |
| size | `number` | 推定ファイルサイズ（バイト、base64からの概算） |
| mimeType | `string` | MIMEタイプ（例: `application/pdf`） |

### FromGroup 構造

| カラム名 | 型 | 説明 |
|----------|-----|------|
| fromAddress | `string` | 送信者メールアドレス（グループキー） |
| fromNames | `string[]` | 同一アドレスの異なる表示名一覧（distinct） |
| count | `number` | 受信件数 |
| frequency | `number` | 受信頻度（件/日） |
| latestSubject | `string` | 最新メールの件名 |
| latestDate | `string` | 最新受信日時 |
| messages | `EmailMessage[]` | グループに属するメール一覧 |
| aiScoreRange | `{ marketing: [min, max], spam: [min, max] }` | AI判定値の範囲 |

リレーション: `account_id` で `profile.json` と 1:1 対応

---

## 10. accounts/{account_id}/cache/sampling_{mode}_meta.json - サンプリングメタ情報

| カラム名 | 型 | 説明 |
|----------|-----|------|
| startDate | `string` | サンプリング開始日 |
| endDate | `string` | サンプリング終了日 |
| fetchedAt | `string` | 取得実行日時（ISO 8601） |
| labelIds | `string[]` | 取得時の対象ラベルID |
| totalCount | `number` | 取得件数 |

リレーション: `account_id` で `profile.json` と 1:1 対応

---

## 11. cache/ai_judgments.json - AI判定キャッシュ（グローバル）

キー: 件名+本文のSHA-256ハッシュ値

| カラム名 | 型 | 説明 |
|----------|-----|------|
| contentHash (key) | `string` | 件名+本文のハッシュ値（キー） |
| marketing | `number` | マーケティング度（0-10） |
| spam | `number` | 迷惑メール度（0-10） |
| judgedAt | `string` | 判定日時（ISO 8601） |

特記: アカウント/From非依存。同一コンテンツは再判定不要。

---

## 12. state/app.json - アプリケーション状態

| カラム名 | 型 | 説明 |
|----------|-----|------|
| lastAccountId | `string \| null` | 前回選択していたアカウントID |
| windowBounds | `WindowBounds \| null` | ウィンドウサイズ・位置 |
| groupModes | `Record<string, GroupMode>` | アカウント別グルーピングモード（`'from'` \| `'subject'` \| `'rule'`） |

### WindowBounds 構造

| カラム名 | 型 | 説明 |
|----------|-----|------|
| x | `number` | ウィンドウX座標 |
| y | `number` | ウィンドウY座標 |
| width | `number` | ウィンドウ幅 |
| height | `number` | ウィンドウ高さ |
| isMaximized | `boolean` | 最大化状態 |

---

## 13. accounts/{account_id}/imap.json - IMAP接続設定

| カラム名 | 型 | デフォルト | 説明 | 暗号化 |
|----------|-----|----------|------|--------|
| host | `string` | `''` | IMAPサーバーホスト名 | - |
| port | `number` | `993` | IMAPサーバーポート番号 | - |
| username | `string` | `''` | ユーザー名 | - |
| password | `string` | `''` | パスワード | AES-256-GCM |
| security | `ImapSecurity` | `'ssl'` | セキュリティ方式（`'none'` \| `'ssl'` \| `'starttls'`） | - |

リレーション: `account_id` で `profile.json` と 1:1 対応。`profile.json`の`provider`が`'imap'`のアカウントにのみ存在。

---

## 14. settings/ai-judgment.json - AI自動判定設定

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|----------|------|
| allowedLanguages | `string[]` | `[]` | 普段受信する言語コードの配列。空配列は「すべて」を意味する |

---

## 15. accounts/{account_id}/rules.json - ルール設定

| カラム名 | 型 | 説明 |
|----------|-----|------|
| ruleText | `string` | ルール定義テキスト（複数行） |
| lines | `RuleLine[]` | パース済みルール行の配列 |

### RuleLine 構造

| カラム名 | 型 | 説明 |
|----------|-----|------|
| patterns | `RulePattern[]` | 同一行内のパターン一覧（AND条件） |
| lineIndex | `number` | ルール行番号（0始まり） |
| rawText | `string` | ルール行の元テキスト |

### RulePattern 構造

| カラム名 | 型 | 説明 |
|----------|-----|------|
| field | `RulePatternField` | 検索対象フィールド（`'subject'` \| `'body'` \| `'any'`） |
| regex | `string` | 正規表現パターン |

リレーション: `account_id` で `profile.json` と 1:1 対応

---

## 暗号化仕様

| 対象ファイル | 対象フィールド | アルゴリズム | 備考 |
|-------------|--------------|-------------|------|
| gcp.json | clientSecret | AES-256-GCM | ランダムキー |
| tokens.json | accessToken, refreshToken | AES-256-GCM | ランダムキー |
| imap.json | password | AES-256-GCM | ランダムキー |

暗号化キー: `settings/encryption-key.bin` にランダム生成した32バイトのバイナリキーとして保存。
IV: 暗号化ごとにランダム16バイト生成。暗号文はIV + AuthTag + CipherTextの結合形式で保存。
